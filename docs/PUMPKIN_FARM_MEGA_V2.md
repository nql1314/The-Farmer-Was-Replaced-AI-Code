# 南瓜农场 Mega 优化版本 V2

## 概述
基于无人机共享内存机制的高效南瓜农场，使用持续验证-修复策略。

## 核心改进

### 1. 共享内存机制
- 使用 `wait_for()` 返回值实现跨无人机的真正共享内存
- 所有无人机共享同一个未验证位置集合
- 无人机可以实时更新集合，相互可见

### 2. 条带分配策略
- **种植阶段**：按行条带分配，每个无人机负责连续的几行
- **验证/修复阶段**：均衡分配未验证位置
- 优势：
  - 最小化移动距离（蛇形遍历）
  - 均衡工作负载
  - 所有无人机几乎同时完成

### 3. 持续工作循环
- **删除所有等待阶段**（`do_a_flip()`）
- 策略：持续验证 -> 修复循环
- 无人机一直工作，不浪费时间
- 当对角线ID一致时立即收获

## 验证逻辑

### 成熟南瓜的判断
```python
# 正确的验证方式
if entity == Entities.Pumpkin:
    if can_harvest():  # 关键：使用 can_harvest() 判断成熟
        # 验证通过
```

**重要发现**：
- ❌ `measure()` 只返回南瓜ID，不能判断是否成熟
- ✅ `can_harvest()` 才是判断成熟的正确方法

## 工作流程

### 阶段1：种植
1. 创建共享未验证集合
2. 按条带分配（每个无人机负责连续几行）
3. 并行种植整个地图
4. 所有位置加入未验证集合

### 阶段2：持续验证和修复循环 + 智能对角线守卫
```
while True:
    1. 检查剩余未验证数量
       if 剩余 <= 无人机数-2:
           启动两个对角线守卫无人机
           - 守卫1：持续检查 (0,0)
           - 守卫2：持续检查 (n-1,n-1)
           - 通过共享内存通信，比较ID
           - ID一致立即报告，主程序立即收获
    
    2. 验证和修复（合并在一起）：
       - 遇到成熟南瓜 -> 验证通过，移除
       - 遇到枯萎南瓜 -> 立即补种，保留在集合
       - 遇到空位置 -> 立即补种，保留在集合
       - 遇到未成熟南瓜 -> 保持在集合，无需操作
    
    3. 检查：
       if 对角线守卫已启动:
           检查守卫是否报告ID一致
           - 是 -> 立即收获
       else:
           定期检查对角线ID
           - 是 -> 跳出循环
    
    # 无等待，立即进入下一轮
```

### 阶段3：收获
- 对角线ID一致时立即收获
- 使用 `harvest_mega_pumpkin()` 收获

## 性能优势

### 相比旧版本
1. **无等待时间**：删除所有 `do_a_flip()`
2. **最优移动**：条带分配 + 蛇形遍历
3. **均衡负载**：所有无人机工作量接近
4. **实时协作**：共享内存机制
5. **合并阶段**：验证和修复在一次遍历中完成，减少移动次数
6. **智能对角线守卫**：
   - 在接近完成时（剩余 ≤ 无人机数-2）启动两个守卫
   - 守卫持续检查对角线，无需等待工作无人机完成
   - 通过共享内存实时通信，ID一致立即报告
   - 实现真正的并行工作，最快发现收获时机

### 批次分配对比
```
旧版本：简单切割
- 批次1: 100个位置
- 批次2: 100个位置
- 批次3: 56个位置  ← 不均衡

新版本：条带分配
- 批次1: 86个位置（3行）
- 批次2: 85个位置（3行）
- 批次3: 85个位置（3行）  ← 均衡
```

## 关键函数

### 共享内存工具
- `create_shared_set()`: 创建共享未验证位置集合
- `create_diagonal_checker()`: 创建对角线验证状态（用于守卫通信）
- `add_to_shared_set()`: 添加位置
- `remove_from_shared_set()`: 移除位置
- `shared_set_to_list()`: 转换为列表

### 批次分配
- `split_batches_by_strips()`: 条带分配（种植/等待）
- `split_batches_balanced()`: 均衡分配（验证/修复）

### 无人机工作函数
- `drone_plant_batch()`: 种植批次
- `drone_verify_and_fix_shared()`: 验证和修复批次（合并验证和修复）
- `drone_diagonal_guard()`: 对角线守卫（持续检查对角线位置，通过共享内存通信）

## 导入的公共函数

从 `farm_utils.py`:
- `goto_pos(x, y)`: 最短路径移动（支持环形地图）
- `check_mega_pumpkin_formed(size)`: 检查对角线ID
- `harvest_mega_pumpkin(size)`: 收获巨型南瓜

## 使用建议

1. **胡萝卜储备**：确保有足够的胡萝卜（地图面积 × 1.2）
2. **无人机数量**：至少3个无人机，越多越快
3. **地图大小**：支持任意大小，建议10×10以上

## 已知限制

1. 安全检查：最多100轮循环（避免无限循环）
2. 竞态条件：多个无人机可能同时操作字典（使用独立键避免）

## 测试结果

- ✅ 共享内存机制正常工作
- ✅ 条带分配均衡负载
- ✅ 验证逻辑正确（使用 `can_harvest()`）
- ✅ 持续工作，无等待时间
- ✅ 对角线ID检测准确

## 下一步优化方向

1. 更智能的修复策略（优先修复靠近已成熟区域的位置）
2. 动态调整批次大小
3. 更细粒度的进度报告

