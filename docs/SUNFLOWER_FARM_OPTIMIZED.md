# 向日葵农场优化版

## 概述

优化版向日葵农场使用单无人机维护共享内存，实现高效的按花瓣数分类收获策略。

## 核心改进

### 1. 共享内存设计
- **单无人机维护**：只用一台无人机专门维护共享内存，降低开销
- **按花瓣数分类**：向日葵按花瓣数分别存储（15-10瓣各一个集合，10以下合并）
- **移除统计开销**：不再维护复杂的统计数据，只保留核心数据
- **占位元素优化**：每个队列保持5个占位元素，避免频繁的空判断和竞态条件

### 2. 算法流程

```
1. 阶段1：种植
   ├─ 所有无人机并行种满整个地图
   ├─ 种植时浇水到含水量 >0.75（4倍生长速度）
   └─ 种植完成后等待3秒确保全部成熟

2. 持续循环：
   ├─ 阶段2：扫描并收获15瓣
   │   ├─ 所有无人机并行扫描地图
   │   ├─ 遇到15瓣：立即收获（最大化5倍奖励）
   │   └─ 其他花瓣：存入共享tracker对应集合
   │
   └─ 阶段3：依次收获其他花瓣
       ├─ 收获14瓣（所有无人机并行）
       ├─ 收获13瓣（所有无人机并行）
       ├─ 收获12瓣（所有无人机并行）
       ├─ 收获11瓣（所有无人机并行）
       ├─ 收获10瓣（所有无人机并行）
       └─ 收获10以下（所有无人机并行）

3. 回到步骤2，直到没有成熟的向日葵
```

## 数据结构

### 共享Tracker
```python
{
    "15": [(x, y), ...],   # 15瓣向日葵位置列表
    "14": [(x, y), ...],   # 14瓣
    "13": [(x, y), ...],   # 13瓣
    "12": [(x, y), ...],   # 12瓣
    "11": [(x, y), ...],   # 11瓣
    "10": [(x, y), ...],   # 10瓣
    "low": [(x, y), ...]   # 10瓣以下合并
}
```

## 性能优化

### 生长速度优化
- **浇水到0.75+**：种植时浇水到含水量 >0.75
  - 生长速度公式：`speed = 1 + 4 × water_level`
  - 0.75含水量：4倍生长速度
  - 基础时间5.6-8.4秒 → 实际1.4-2.1秒
- **等待成熟**：种植完成后等待3秒，确保所有向日葵成熟后再开始扫描

### 5倍奖励最大化
- **优先收获15瓣**：在扫描阶段立即收获15瓣，确保满足5倍奖励条件（≥10株成熟+最大花瓣）
- **按降序收获**：14→13→12...确保每次收获时都是最大花瓣数

### 并行效率
- **种植阶段**：所有无人机并行种植，最快速度覆盖地图
- **扫描阶段**：所有无人机并行扫描，快速分类所有成熟向日葵
- **收获阶段**：动态任务队列，无人机自动从共享队列中取任务
  - 无人机持续从队列中pop位置
  - 自动跳过已被收获的位置
  - 无需预先分配批次，负载自动平衡
  - 最大化并行效率和容错性

### 共享内存开销最小化
- 只维护位置列表，不维护复杂统计
- 收获后立即清空对应集合，减少内存占用

## 输出信息

每轮完成后输出：
```
本轮完成: 收获 XXX 株, 能量 +XXX, 用时 XXX.XXs, 效率 XXX.XX 株/s
```

## 动态任务队列机制

### 工作原理
```python
# 所有无人机同时启动
for each drone:
    while queue not empty:
        position = queue.pop()  # 从共享队列取一个位置
        goto(position)
        if can_harvest:
            harvest()
        # 如果已被收获，自动跳过
```

### 优势
1. **负载自动平衡**：无人机自动获取任务，不会出现某些无人机闲置的情况
2. **容错性强**：如果某个位置已被收获（竞态条件），自动跳过
3. **简化逻辑**：无需预先计算批次分配
4. **高效利用**：无人机持续工作直到队列为空

## 与旧版对比

| 特性 | 旧版 | 优化版 |
|------|------|--------|
| 共享内存无人机数 | 2台（tracker + stats） | 1台（只有tracker） |
| 数据结构 | 位置键字典 | 按花瓣分类的列表 |
| 扫描策略 | 只扫描 | 扫描同时收获15瓣 |
| 收获策略 | 预分配批次 | 动态任务队列 |
| 负载平衡 | 静态分配 | 自动平衡 |
| 容错性 | 无 | 自动跳过重复收获 |
| 统计信息 | 详细统计 | 精简效率统计 |

## 使用方法

直接运行脚本即可，会自动进入无限循环：

```python
python sunflower_farm_mega.py
```

## 依赖

- `farm_utils.py`：提供 `goto_pos()` 函数

